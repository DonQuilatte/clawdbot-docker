#!/bin/bash
# agy - Router that detects context and chooses execution automatically
# Enhanced with smart detection

set -e

PROJECTS_DIR="$HOME/Development/Projects"

# Detect if we're in a project directory
detect_project() {
    local current_dir="$PWD"
    
    # Check if we're in a project (has .envrc or scripts/project-setup.sh)
    if [[ "$current_dir" == "$PROJECTS_DIR"/* ]] && \
       { [ -f ".envrc" ] || [ -f "scripts/project-setup.sh" ]; }; then
        basename "$current_dir"
        return 0
    fi
    return 1
}

# No arguments - smart mode
if [ $# -eq 0 ]; then
    PROJECT_NAME=$(detect_project)
    
    if [ -n "$PROJECT_NAME" ]; then
        echo "üìç Detected project: $PROJECT_NAME"
        echo "üöÄ Starting local Claude session..."
        exec "$(dirname "$0")/agy-local" "$PROJECT_NAME"
    else
        echo "Usage: agy [options] <project-or-url> [prompt]"
        echo ""
        echo "Smart mode (no arguments):"
        echo "  Run 'agy' from a project directory to auto-start"
        echo ""
        echo "Options:"
        echo "  -r, --remote    Use TW Mac (remote execution with job tracking)"
        echo "  -l, --local     Use this Mac (local execution)"
        echo ""
        echo "Examples:"
        echo "  cd ~/Development/Projects/myapp && agy              # Auto-detect & start local"
        echo "  agy myapp                                            # Start local"
        echo "  agy -r myapp \"analyze code\"                         # Start remote + track job"
        echo "  agy git@github.com:you/repo.git                      # Clone + start local"
        exit 1
    fi
fi

# With arguments - check for flags and subcommands
case "$1" in
    -r|--remote)
        shift
        exec "$(dirname "$0")/agy-project" "$@"
        ;;
    -l|--local)
        shift
        exec "$(dirname "$0")/agy-local" "$@"
        ;;
    # Sync commands
    sync)
        shift
        exec "$(dirname "$0")/agy-sync" "$@"
        ;;
    health|check)
        shift
        exec "$(dirname "$0")/agy-health" "$@"
        ;;
    init)
        shift
        exec "$(dirname "$0")/agy-init" "$@"
        ;;
    upstream)
        shift
        if [ "${1:-}" = "check" ] || [ -z "${1:-}" ]; then
            exec bun run "$(dirname "$0")/check-upstream.ts"
        else
            exec bun run "$(dirname "$0")/sync-upstream.ts" "$@"
        fi
        ;;
    # Dependency commands
    dependabot|deps)
        shift
        exec bun run "$(dirname "$0")/dependabot-triage.ts" "$@"
        ;;
    manifest)
        echo "manifest command not yet implemented"
        exit 1
        ;;
    # Help
    help|--help|-h)
        echo "agy - Antigravity CLI"
        echo ""
        echo "Usage: agy [command] [options]"
        echo ""
        echo "Session commands:"
        echo "  (no args)           Auto-detect project, start Claude"
        echo "  -r, --remote        Use TW Mac for execution"
        echo "  -l, --local         Use this Mac for execution"
        echo ""
        echo "Project commands:"
        echo "  init [path]         Initialize project for Path 3"
        echo "  health [path]       Validate Path 3 setup"
        echo "  sync [--update]     Sync dev-infra to downstream projects"
        echo ""
        echo "Upstream commands:"
        echo "  upstream            Check upstream repos for updates"
        echo "  upstream <repo>     Sync specific upstream repo"
        echo ""
        echo "Other commands:"
        echo "  deps                Triage Dependabot alerts"
        echo "  help                Show this help"
        exit 0
        ;;
    *)
        # Default to local
        exec "$(dirname "$0")/agy-local" "$@"
        ;;
esac
