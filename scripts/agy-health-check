#!/bin/bash
# agy-health-check - Verify Antigravity environment and MCP health
#
# Part of Path 3: Zero-Command Integration

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

LOG_FILE="/tmp/agy-health-check-$(date +%Y%m%d).log"
log() { echo "[$(date '+%H:%M:%S')] $*" >> "$LOG_FILE"; }

# Helper for status
status_pass() { echo -e "${GREEN}✅ PASS${NC}: $1"; }
status_fail() { echo -e "${RED}❌ FAIL${NC}: $1"; }
status_warn() { echo -e "${YELLOW}⚠️  WARN${NC}: $1"; }

echo -e "${BLUE}=== Antigravity Health Check ===${NC}"

# 1. Environment Check
echo -e "\n${BLUE}1. Environment:${NC}"
if [ -n "${PROJECT_ROOT:-}" ]; then
    status_pass "PROJECT_ROOT is set to $PROJECT_ROOT"
else
    status_fail "PROJECT_ROOT is not set"
fi

if command -v direnv &>/dev/null; then
    status_pass "direnv is installed"
else
    status_fail "direnv is not installed"
fi

# 2. Secret Check
echo -e "\n${BLUE}2. Secrets:${NC}"
if [ -f ".antigravity/config.json" ]; then
    REQUIRED_SECRETS=$(jq -r '.secrets[]? // empty' .antigravity/config.json 2>/dev/null)
    if [ -n "$REQUIRED_SECRETS" ]; then
        for secret in $REQUIRED_SECRETS; do
            if [ -n "${!secret:-}" ]; then
                status_pass "Secret $secret is available"
            else
                status_fail "Secret $secret is MISSING"
            fi
        done
    else
        status_pass "No secrets required in config"
    fi
else
    status_warn "No .antigravity/config.json found"
fi

# 3. MCP Check
echo -e "\n${BLUE}3. MCP Servers:${NC}"
MCP_CONFIG="$HOME/.gemini/mcp_config.json"
if [ -L "$MCP_CONFIG" ] || [ -f "$MCP_CONFIG" ]; then
    status_pass "Antigravity MCP config exists"
    
    # Check if symlinked to current project
    TARGET=$(readlink "$MCP_CONFIG" || echo "$MCP_CONFIG")
    if [[ "$TARGET" == *"$PWD"* ]]; then
        status_pass "MCP config is correctly linked to this project"
    else
        status_warn "MCP config is linked elsewhere: $TARGET"
    fi
    
    # Check server count
    COUNT=$(jq '.mcpServers | length' "$MCP_CONFIG" 2>/dev/null || echo 0)
    status_pass "Found $COUNT MCP servers configured"
else
    status_fail "Antigravity MCP config not found at $MCP_CONFIG"
fi

# 4. Git Check
echo -e "\n${BLUE}4. Git Integration:${NC}"
if [ -d ".git" ]; then
    BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
    status_pass "On branch: $BRANCH"
else
    status_warn "Not a git repository"
fi

echo -e "\n${BLUE}Health check complete.${NC}"
