version: "3.8"

services:
  clawdbot-gateway:
    build:
      context: .
      dockerfile: Dockerfile.secure
    image: clawdbot/gateway:secure
    container_name: clawdbot-gateway-secure
    restart: unless-stopped

    # Security: Non-root user
    user: "1000:1000"

    # Security: Read-only root filesystem
    read_only: true

    # Security: Drop all capabilities, add only required ones
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Only if binding to port < 1024

    # Security: No new privileges
    security_opt:
      - no-new-privileges:true
      - seccomp=seccomp-profile.json

    # Network configuration
    ports:
      - "127.0.0.1:${CLAWDBOT_GATEWAY_PORT:-3000}:3000" # Localhost only

    networks:
      - clawdbot-network

    # Environment variables
    environment:
      - NODE_ENV=production
      - CLAWDBOT_HOME=/data
      - LOG_LEVEL=${CLAWDBOT_LOG_LEVEL:-info}
      - GATEWAY_BIND=localhost
      - FORCE_COLOR=0

    # Volume mounts with security options
    volumes:
      # Data volume (read-write, but limited)
      - type: bind
        source: ${CLAWDBOT_HOME_VOLUME:-./data}
        target: /data
        read_only: false

      # Temporary directories (required for read-only root)
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M
          mode: 1777

      - type: tmpfs
        target: /var/tmp
        tmpfs:
          size: 50M
          mode: 1777

      - type: tmpfs
        target: /run
        tmpfs:
          size: 10M
          mode: 0755

      # Docker socket (read-only, optional - remove if not needed)
      # - type: bind
      #   source: /var/run/docker.sock
      #   target: /var/run/docker.sock
      #   read_only: true

    # Resource limits (enforced)
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
          pids: 100 # Limit number of processes
        reservations:
          cpus: "0.5"
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=clawdbot-gateway"

  clawdbot-cli:
    build:
      context: .
      dockerfile: Dockerfile.secure
    image: clawdbot/cli:secure
    container_name: clawdbot-cli-secure
    profiles:
      - cli

    # Security: Non-root user
    user: "1000:1000"

    # Security: Read-only root filesystem
    read_only: true

    # Security: Drop all capabilities
    cap_drop:
      - ALL

    # Security: No new privileges
    security_opt:
      - no-new-privileges:true

    environment:
      - CLAWDBOT_HOME=/data
      - LOG_LEVEL=${CLAWDBOT_LOG_LEVEL:-info}

    volumes:
      - type: bind
        source: ${CLAWDBOT_HOME_VOLUME:-./data}
        target: /data
        read_only: false

      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 50M
          mode: 1777

    networks:
      - clawdbot-network

    depends_on:
      - clawdbot-gateway

networks:
  clawdbot-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: clawdbot0
      com.docker.network.bridge.enable_ip_masquerade: "true"
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    # Network isolation
    internal: false # Set to true for complete isolation (no internet)

volumes:
  clawdbot-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CLAWDBOT_HOME_VOLUME:-./data}
